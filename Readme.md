# Сервис для скачивания файлов.

## Что делает сервис:
Сервис получает задачу. В задаче указан список *URL ссылок*, по которым нужно скачать файлы. Скаченные файлы хранятся локально в одной папке.

## Как работает сервис:
Сервис обрабатывает HTTP запросы и реализует 2 метода:
- **Метод POST:** Получает json, в котором указаны: Id задачи, список URL ссылок. Получив задание, оно попадает в менеджер, который добавляет задачу в очередь. Параллельно работает обработчик, он каждые 5 секунд проверяет очередь на наличие задач. При наличии задачи он забирает её из очереди и производит скачивание по каждой ссылке. После каждого окончания скачивания файла по ссылке, обновляет информацию о задаче и сохраняет её в репозиторий. По окончании обработки задачи, отдаёт команду очереди, чтобы та смогла обновиться и сохранить своё состояние в файл.

- **Метод Get:** Получает Id задачи, по которому получает информацию о ней и возвращает в формате json.

## Реализация инструментария:
- **Менеджер:** Имеет 2 метода - *AddTask* и *GetTask*. 
    - **AddTask** принимает модель создания задачи. На основе её данных создает задачу с статусом *"Получено"* и временем создания. После этого добавляет задачу в очередь.
    - **GetTask** принимает Id задачи и получает по нему задачу из репозитория. После чего возвращает информацию о ней. В случае неудачного запроса, возвращает ошибку.

- **Обработчик задачи (Worker):** Имеет 1 метод *ProcessTask*:
    - **ProcessTask** каждые 5 секунд проверяет очередь на наличие задач. Также проверяет сигнал остановки сервиса. Получает из очереди модель задачи. Меняет статус на *"В работе"* и проверяет каждую URL ссылку. Если ссылка ещё не обработанна, то обращается к обработчику URL, дожидается обработки, и добавляет в модель задачи URL ссылку, в случае успеха сохраняет путь к файлу, в случае неудачи записывает ошибку. Сохраняет модель в репозиторий, после каждой обработанной URL ссылки. Проверяет сигнал остановки, перед обработкой следующей URL ссылки. После окончания обработки задачи ставит статус "Завершено". Сохраняет в репозиторий и сообщает очереди, что задача обработана.

- **Репозиторий:** Имеет 2 метода - *Save* и *Get*:
    - **Save** получает модель задачи. Парсит модель в json. Создаёт или пересоздаёт файл c именем которого является Id задачи. Сохраняет в файл информацию о задаче.
    - **Get** получает Id задачи. Проверяет существование файла, который хранит информацию о задаче. Если файл существует, читает его и возвращает задачу, иначе возвращает ошибку.
- **Очередь:** Имеет 4 метода - *Enqueue*, *Dequeue*, *IsEmpty*, *TaskCompleated*:
    - **Enqueue** получает модель задачи. Открывает файл хранящий состояние очереди, дописывает в конец Id задачи. Сохраняет информацию о задаче в репозиторий. Добавляет модель задачи в очередь(слайс хранящий модели задач, которая хранится в памяти), так же добавляет Id задачи в очередь(слайс хранящий Id задач).
    - **Dequeue** проверяет очередь на пустоту. Получает задачу из очереди (получает модель задачи из слайса). Удаляет из слайса полученную задачу. Возвращяет модель задачи.
    - **IsEmpty** проверяет очередь на пустоту, если очередь пуста возвращает true, иначе false(проверяет слайс, который хранить модели задач).
    - **TaskCompleated** получает Id выполненной задачи. Находит Id в очереди (слайс хранящий Id задач). Удаляет из очереди Id задачи и пересохраняет состояние очереди(слайс, хранящий Id задач) в файл.
- **Обработчик URL ссылки(Handler):** Имеет 1 метод *Download*:
    - **Download** получает URL ссылку. Проверяет ссылку на валидность. Отправляет Get запрос, в ответе которого должен храниться файл. Проверяет статус-код выполнения запроса. Создаёт файл, имя файла берется из URL ссылки. Копирует данные из тела ответа в созданный файл. Возвращает путь к файлу, в случае неудачи возвращяет ошибку.

## Запуск сервиса:
Создаётся контекст, который даёт сигнал для завершения. В отдельной горутине запускается функция *StopContext* которая ожидает сигнала остановки сервиса. Если сигнал получен, вызывается сигнал отмены, который слушает обработчик(Worker) и серевер.

Вызываются конструкторы:
- Создание обработчика URL ссылок (передаётся путь, куда должны загружаться файлы). Проверят существует ли папка или нет, если папка не существует, то создаёт её.

- Создание репозитория (передаётся путь, где должны храниться файлы хранящие информацию о задачах). Проверяет существование папки, если не существует, то создаёт её.

- Создание очереди(передаётся путь папки, где должен храниться файл очереди, и передаётся название файла). Проверяет существование папки и файла, в случае отсутствия создаёт. Если файл существует читает его и на основе этих данных создаёт очередь.

- Создание менеджера (передаётся ссылка на репозиторий и очередь).

- Создание обработчика задач (Worker) (передаются ссылки на обработчик URL, на очередь, на репозиторий, так же передаётся ссылка на группу ожидания, которая отвечает за синхронизированную остановку сервисов, передаётся контекст, который сообщит обработчику о команде остановки сервиса).

- Запускаются обработчики задач.

- Прописывается маршрутизация запросов.

- Создается HTTP сервер с поддержкой корректной остановки.

- В отдельной горутине запускается сервер.
